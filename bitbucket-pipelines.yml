#  CI/CD Implementation

image: python:3.8

definitions:
  caches:
    rsync: /usr/bin/


pipelines:
  branches:
    master:
    - step:
        name: Install RSync
        caches:
            - rsync
        script:
            - if ! which rsync >/dev/null; then wget http://ftp.us.debian.org/debian/pool/main/p/popt/libpopt0_1.18-3_amd64.deb && apt install ./libpopt0_1.18-3_amd64.deb && wget http://ftp.us.debian.org/debian/pool/main/r/rsync/rsync_3.2.3-8_amd64.deb; apt install ./rsync_3.2.3-8_amd64.deb; fi

    - step:
        name: Copy to Server and Run
        deployment: production
        clone:
            enabled: false
        script:
            - rsync -avz --exclude='.env' --delete -P -e "ssh -i /opt/atlassian/pipelines/agent/ssh/id_rsa -o StrictHostKeyChecking=no" ./ $USER@$HOST:$PROJECT_PATH
            - ssh -A -tt -i /opt/atlassian/pipelines/agent/ssh/id_rsa -o 'StrictHostKeyChecking=no' -p ${PORT:-22} $USER@$HOST "bash -c '${PROJECT_PATH}/deploy.sh ${BITBUCKET_COMMIT}'"
